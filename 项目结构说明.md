# WPIC 项目结构说明

## 📁 优化后的FastAPI官方推荐结构

根据FastAPI官方最佳实践，我们已经将项目重构为以下标准结构：

```
wpic/
├── app/                           # 应用核心包
│   ├── __init__.py               
│   ├── models.py                  # SQLAlchemy/Ormar数据模型
│   │
│   ├── core/                      # 核心功能模块
│   │   ├── __init__.py           
│   │   ├── config.py             # 配置管理
│   │   ├── database.py           # 数据库连接和初始化
│   │   ├── security.py           # 认证和安全功能
│   │   ├── cache.py              # Redis缓存管理
│   │   ├── deps.py               # 依赖注入
│   │   └── utils.py              # 通用工具函数
│   │
│   ├── api/                       # API路由层
│   │   ├── __init__.py           
│   │   ├── router.py             # 主路由汇总
│   │   ├── auth_routes.py        # 认证相关接口
│   │   ├── file_routes.py        # 文件管理接口
│   │   ├── admin_routes.py       # 管理员接口
│   │   └── schemas.py            # Pydantic模型(请求/响应)
│   │
│   ├── crud/                      # 数据库CRUD操作
│   │   ├── __init__.py           
│   │   ├── user.py               # 用户相关数据操作
│   │   └── file.py               # 文件相关数据操作
│   │
│   ├── services/                  # 业务逻辑服务层
│   │   ├── __init__.py           
│   │   ├── image_service.py      # 图片处理服务
│   │   └── storage_service.py    # 存储管理服务
│   │
│   └── storage/                   # 存储后端实现
│       ├── __init__.py           
│       ├── base.py               # 存储抽象基类
│       ├── local.py              # 本地存储实现
│       ├── webdav.py             # WebDAV存储实现
│       └── s3.py                 # S3存储实现
│
├── main.py                        # FastAPI应用入口
├── requirements.txt               # 项目依赖
├── config.example.env             # 配置示例
├── Dockerfile                     # Docker构建文件
├── docker-compose.yml             # Docker编排文件
└── 其他工具和文档文件...
```

## 🏗️ 架构说明

### 1. **核心层 (app/core/)**
包含应用的核心功能和基础设施代码：

- **config.py**: 配置管理，支持环境变量和配置文件
- **database.py**: 数据库连接池和会话管理
- **security.py**: 认证、授权、密码处理
- **cache.py**: Redis缓存抽象层
- **deps.py**: FastAPI依赖注入定义
- **utils.py**: 通用工具函数

### 2. **API层 (app/api/)**
处理HTTP请求和响应：

- **router.py**: 汇总所有API路由
- **auth_routes.py**: 用户认证相关接口
- **file_routes.py**: 文件上传下载管理
- **admin_routes.py**: 系统管理接口
- **schemas.py**: 请求/响应数据模型

### 3. **CRUD层 (app/crud/)**
数据访问层，封装数据库操作：

- **user.py**: 用户数据的增删改查
- **file.py**: 文件记录的数据操作

### 4. **服务层 (app/services/)**
业务逻辑层，处理复杂的业务规则：

- **image_service.py**: 图片处理和优化
- **storage_service.py**: 存储后端管理

### 5. **存储层 (app/storage/)**
存储抽象和实现：

- **base.py**: 存储接口定义
- **local.py**: 本地文件系统存储
- **webdav.py**: WebDAV协议存储
- **s3.py**: S3对象存储

## 🔄 数据流向

```
HTTP请求 → API路由 → 依赖注入 → 业务服务 → CRUD操作 → 数据库/存储
         ↓
    Pydantic验证 → 业务逻辑 → 数据访问 → 持久化
         ↓
    响应序列化 ← 结果处理 ← 数据返回 ← 存储层
```

## 🌟 设计优势

### 1. **符合FastAPI最佳实践**
- 清晰的模块分离
- 标准的依赖注入模式
- 规范的路由组织

### 2. **高内聚低耦合**
- 每个模块职责单一
- 接口定义清晰
- 易于测试和维护

### 3. **可扩展性强**
- 插件化的存储后端
- 模块化的服务设计
- 标准化的接口规范

### 4. **开发友好**
- 清晰的代码组织
- 便于团队协作
- 易于新功能添加

## 📝 与原结构对比

### 重构前:
```
app/
├── api/
├── auth.py          # 所有认证逻辑
├── cache.py         # 缓存功能
├── config.py        # 配置管理
├── database.py      # 数据库
├── image_processor.py  # 图片处理
├── storage_manager.py  # 存储管理
└── utils.py         # 工具函数
```

### 重构后:
```
app/
├── core/           # 核心基础设施
├── api/            # API接口层
├── crud/           # 数据访问层
├── services/       # 业务逻辑层
└── storage/        # 存储实现层
```

## 🚀 使用说明

### 导入规范
```python
# 核心功能
from app.core.config import get_settings
from app.core.security import get_current_user
from app.core.deps import get_cache

# API相关
from app.api.schemas import UserResponse
from app.api.router import api_router

# 业务逻辑
from app.services.image_service import get_image_processor
from app.crud.user import get_user_by_id

# 数据模型
from app.models import User, FileRecord
```

### 新增功能
1. **新增API接口**: 在 `app/api/` 下创建路由文件
2. **新增业务逻辑**: 在 `app/services/` 下创建服务文件
3. **新增数据操作**: 在 `app/crud/` 下创建CRUD文件
4. **新增存储后端**: 在 `app/storage/` 下实现存储接口

## ✅ 优化成果

1. **✅ 使用redis-py**: 已更新为标准的redis-py客户端
2. **✅ FastAPI标准结构**: 完全符合官方推荐的项目组织方式
3. **✅ 清晰的分层架构**: 核心、API、业务、数据四层分离
4. **✅ 规范的依赖注入**: 使用FastAPI标准的依赖模式
5. **✅ 模块化设计**: 每个模块职责明确，易于维护

这个重构后的结构更加专业，符合现代Python Web应用的最佳实践！🎉
